name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get build info FROM MAIN BRANCH
        id: info
        run: |
          # Get info from current HEAD (main branch)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_SHA_FULL=$(git rev-parse HEAD)
          COMMIT_DATE=$(git log -1 --pretty=format:'%ai')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -1)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Count commits on main branch
          COMMIT_COUNT=$(git rev-list --count HEAD)
          
          # Calculate version
          MAJOR=$((COMMIT_COUNT / 100))
          MINOR=$(((COMMIT_COUNT % 100) / 10))
          PATCH=$((COMMIT_COUNT % 10))
          VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          # Save to outputs
          echo "sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "sha_full=${COMMIT_SHA_FULL}" >> $GITHUB_OUTPUT
          echo "date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
          echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT
          echo "message=${COMMIT_MESSAGE}" >> $GITHUB_OUTPUT
          echo "count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Print for debugging
          echo "üìä Build Information:"
          echo "  Version: ${VERSION}"
          echo "  Build: #${COMMIT_COUNT}"
          echo "  Commit: ${COMMIT_SHA}"
          echo "  Author: ${COMMIT_AUTHOR}"
          echo "  Message: ${COMMIT_MESSAGE}"
      
      - name: Create HTML page
        run: |
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Deployment Info</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      padding: 20px;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 15px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                      max-width: 700px;
                      width: 100%;
                  }
                  h1 {
                      color: #333;
                      margin-bottom: 10px;
                      font-size: 2em;
                  }
                  .version {
                      display: inline-block;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 8px 20px;
                      border-radius: 20px;
                      font-size: 1.1em;
                      font-weight: bold;
                      margin-bottom: 30px;
                  }
                  .info {
                      margin: 20px 0;
                      padding: 15px;
                      background: #f8f9fa;
                      border-radius: 8px;
                      border-left: 4px solid #667eea;
                  }
                  .label {
                      font-weight: bold;
                      color: #666;
                      display: inline-block;
                      min-width: 120px;
                  }
                  .value {
                      color: #333;
                      font-family: 'Courier New', monospace;
                  }
                  .commit-msg {
                      background: #e8f4f8;
                      padding: 15px;
                      border-radius: 8px;
                      margin-top: 20px;
                      border-left: 4px solid #48bb78;
                  }
                  .commit-msg .label {
                      display: block;
                      margin-bottom: 8px;
                  }
                  .commit-msg .value {
                      color: #2d3748;
                      font-size: 1.05em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Deployment Info</h1>
                  <div class="version">VERSION_NUMBER ‚Ä¢ Build #BUILD_COUNT</div>
                  
                  <div class="info">
                      <span class="label">üìÖ Deployed:</span>
                      <span class="value">DEPLOY_DATE</span>
                  </div>
                  
                  <div class="info">
                      <span class="label">üìù Commit:</span>
                      <span class="value">COMMIT_SHA</span>
                  </div>
                  
                  <div class="info">
                      <span class="label">üî¢ Build Number:</span>
                      <span class="value">#BUILD_COUNT</span>
                  </div>
                  
                  <div class="info">
                      <span class="label">üë§ Author:</span>
                      <span class="value">COMMIT_AUTHOR</span>
                  </div>
                  
                  <div class="info">
                      <span class="label">‚è∞ Commit Date:</span>
                      <span class="value">COMMIT_DATE</span>
                  </div>
                  
                  <div class="commit-msg">
                      <span class="label">üí¨ Commit Message:</span>
                      <span class="value">COMMIT_MESSAGE</span>
                  </div>
                  
                  <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #718096; font-size: 0.9em;">
                      <p>Full SHA: <code>COMMIT_SHA_FULL</code></p>
                      <p style="margin-top: 10px;">Auto-deployed via GitHub Actions</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Replace placeholders with actual values
          sed -i "s|VERSION_NUMBER|${{ steps.info.outputs.version }}|g" index.html
          sed -i "s|DEPLOY_DATE|${{ steps.info.outputs.date }}|g" index.html
          sed -i "s|COMMIT_SHA|${{ steps.info.outputs.sha }}|g" index.html
          sed -i "s|COMMIT_SHA_FULL|${{ steps.info.outputs.sha_full }}|g" index.html
          sed -i "s|BUILD_COUNT|${{ steps.info.outputs.count }}|g" index.html
          sed -i "s|COMMIT_AUTHOR|${{ steps.info.outputs.author }}|g" index.html
          sed -i "s|COMMIT_DATE|${{ steps.info.outputs.commit_date }}|g" index.html
          sed -i "s|COMMIT_MESSAGE|${{ steps.info.outputs.message }}|g" index.html
          
          echo "‚úÖ Generated index.html"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          commit_message: 'Deploy ${{ steps.info.outputs.version }} - ${{ steps.info.outputs.message }}'